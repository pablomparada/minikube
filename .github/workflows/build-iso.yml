name: Build Minikube ISO ARM64 with Chaos Mesh Support

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          docker system prune -af
          
          echo "After cleanup:"
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y genisoimage ipset

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Checkout minikube fork with Chaos Mesh support
        run: git clone --depth 1 https://github.com/pablomparada/minikube.git

      - name: Verify Chaos Mesh kernel modules in defconfig
        run: |
          cd minikube
          DEFCONFIG="deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig"
          
          echo "=== NET_SCH/NET_CLS configs in defconfig ==="
          grep -E "NET_SCH_|NET_CLS_" "$DEFCONFIG"
          
          # Verify required modules are present
          REQUIRED="CONFIG_NET_SCH_HTB=y CONFIG_NET_SCH_PRIO=y CONFIG_NET_SCH_NETEM=y"
          for MODULE in $REQUIRED; do
            if grep -q "^${MODULE}$" "$DEFCONFIG"; then
              echo "OK: $MODULE"
            else
              echo "ERROR: $MODULE not found in defconfig"
              exit 1
            fi
          done

      - name: Build buildroot image
        run: |
          cd minikube
          make buildroot-image

      - name: Build ARM64 ISO
        run: |
          cd minikube
          make minikube-iso-aarch64

      - name: Verify kernel config has Chaos Mesh modules
        run: |
          cd minikube
          
          echo "=== Searching for generated kernel .config ==="
          KERNEL_CONFIG=$(find out -name ".config" -path "*linux*" 2>/dev/null | head -1)
          
          if [ -z "$KERNEL_CONFIG" ]; then
            echo "ERROR: Could not find kernel .config file"
            find out -name ".config" 2>/dev/null | head -10
            exit 1
          fi
          
          echo "Found kernel config at: $KERNEL_CONFIG"
          echo ""
          
          # Required modules for Chaos Mesh NetworkChaos
          REQUIRED_MODULES=(
            "CONFIG_NET_SCH_HTB=y"
            "CONFIG_NET_SCH_PRIO=y"
            "CONFIG_NET_SCH_SFQ=y"
            "CONFIG_NET_SCH_TBF=y"
            "CONFIG_NET_SCH_NETEM=y"
          )
          
          FAILED=0
          echo "=== Checking required Chaos Mesh modules ==="
          for MODULE in "${REQUIRED_MODULES[@]}"; do
            if grep -q "^${MODULE}$" "$KERNEL_CONFIG"; then
              echo "OK: $MODULE"
            else
              echo "MISSING: $MODULE"
              MODULE_NAME=$(echo "$MODULE" | cut -d= -f1)
              grep "$MODULE_NAME" "$KERNEL_CONFIG" || echo "   (not found at all)"
              FAILED=1
            fi
          done
          
          echo ""
          echo "=== All NET_SCH/NET_CLS configs in .config ==="
          grep -E "NET_SCH_|NET_CLS_" "$KERNEL_CONFIG" | head -30
          
          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "BUILD FAILED: Required Chaos Mesh kernel modules are missing!"
            echo "The ISO will NOT support NetworkChaos experiments."
            exit 1
          fi
          
          echo ""
          echo "All required Chaos Mesh modules are present!"

      - name: Verify ISO was created
        run: |
          cd minikube
          
          echo "=== ISO file info ==="
          ls -lh out/minikube-arm64.iso
          
          echo ""
          echo "=== ISO checksum ==="
          sha256sum out/minikube-arm64.iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: minikube-arm64-chaos-mesh
          path: minikube/out/minikube-arm64.iso
          retention-days: 7

