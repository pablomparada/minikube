name: Build Minikube ISO ARM64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          docker system prune -af
          
          echo "After cleanup:"
          df -h

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Checkout minikube
        run: git clone --depth 1 https://github.com/kubernetes/minikube.git

      - name: Add kernel modules
        run: |
          cd minikube
          echo "" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "# Chaos Mesh NetworkChaos support" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_SCH_HTB=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_SCH_PRIO=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_SCH_SFQ=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_SCH_TBF=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_SCH_NETEM=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_CLS_FW=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_CLS_U32=m" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig
          echo "CONFIG_NET_CLS_MATCHALL=y" >> deploy/iso/minikube-iso/board/minikube/aarch64/linux_aarch64_defconfig

      - name: Build buildroot image
        run: |
          cd minikube
          make buildroot-image

      - name: Build ARM64 ISO
        run: |
          cd minikube
          make minikube-iso-aarch64

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: minikube-aarch64-chaos-mesh
          path: minikube/out/minikube-aarch64.iso
          retention-days: 7
